<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Website</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBxcGbtIQFIgaMtns+p/RHOvBBQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <header>
        <div class="logo">
            <a href="#"> <img src="gjslogo.jpg" alt="GJ'S Beauty Lounge Logo">
            </a>
        </div>
        <div class="header-text">
            <h1>Nails, Facials, Brows, Lashes, Waxing, Gluta Spa <span>Clinic Hours: 9AM - 8PM</span></h1>
        </div>
       <nav>
    <ul>
        <li><a href="reviews.html">Reviews</a></li>
        <li><a href="faq.html">FAQ</a></li>
        <li><a href="services.html">Services</a></li>
        <li id="loginNavItem"><a href="#" id="loginLink">Login</a></li>
        <li id="registerNavItem"><a href="#" id="registerLink">Register</a></li>
        <li id="userNav" style="display: none;"> <span id="usernameDisplay" style="margin-right: 10px;">Welcome</span> <a href="dashboard.html" style="margin-right: 10px;">Dashboard</a> <a href="#" id="logoutButton">Logout</a>
        </li>
    </ul>
</nav>
    </header>

    <main>
        <section class="hero">
            <div class="hero-left">
                <img src="1st hp.jpg" alt="Left Image" class="boxed-image">
            </div>
            <div class="hero-center">
                <img src="book.png" alt="Center Image" class="circular-image">
            </div>
            <div class="hero-right">
                <img src="2ndhp.jpg" alt="Right Image" class="boxed-image">
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-section">
            <h3>More about Company</h3>
            <p>GJ's Beauty Lounge is dedicated to enhancing beauty and confidence through professional services, including
                nails, brows, lashes, waxing, and gluta spa treatments. With a commitment to quality and customer
                satisfaction, we create a relaxing space where clients can enjoy top-tier beauty care.</p>
        </div>
        <div class="footer-section">
            <h3>Keep Connected</h3>
            <div class="social-links">
                <a href="#" target="_blank"><i class="fab fa-facebook"></i> Facebook</a>
                <a href="#" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>
            </div>
        </div>
        <div class="footer-section">
            <h3>Contact Information</h3>
            <p><i class="fas fa-map-marker-alt"></i> Lower Ground Floor, Nova Plaza Mall, Quirino Highway, Novaliches
                Proper, Quezon City</p>
            <p><i class="fas fa-phone"></i> 0962-847-2488</p>
            <p><i class="fas fa-envelope"></i> <a href="mailto:gjsbeautylounge@gmail.com">gjsbeautylounge@gmail.com</a></p>
        </div>
    </footer>

    <div id="loginModal" class="modal">
        <div class="modal-content login-modal-content">
            <span class="close-button login-close-button">&times;</span>
            <div class="modal-header login-modal-header">
                <img src="gjslogo.jpg" alt="GJ'S Logo" class="modal-form-logo">
                <h2 class="modal-form-title">Login Form</h2>
            </div>
            <div class="modal-form-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="login-email-user">Username:</label> <input type="text" id="login-email-user" name="username" required> </div>
                    <div class="form-group">
                        <label for="login-password">Password:</label>
                        <input type="password" id="login-password" name="password" required>
                    </div>
                    <button type="submit">Login</button>
                    <p class="register-link">
                        Don't have an Account? <a href="#" id="switchToRegister">Register here</a>
                    </p>
                    </form>
            </div>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content register-modal-content">
            <span class="close-button register-close-button">&times;</span>
            <div class="modal-form-header">
                <img src="gjslogo.jpg" alt="GJ'S Logo" class="modal-form-logo">
                <h2 class="modal-form-title">Registration Form</h2>
            </div>
            <form id="registrationForm" class="modal-form-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="reg-lastname">Lastname:</label>
                        <input type="text" id="reg-lastname" name="lastname" placeholder="Lastname" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-firstname">Firstname:</label>
                        <input type="text" id="reg-firstname" name="firstname" placeholder="Firstname" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reg-email">Email:</label>
                        <input type="email" id="reg-email" name="email" placeholder="example@gmail.com" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-contact">Contact No.:</label>
                        <input type="tel" id="reg-contact" name="contact" placeholder="+63 123 123 123" required>
                    </div>
                </div>
                <div class="form-group gender-group">
                    <label>Gender:</label>
                    <div class="radio-options">
                        <input type="radio" id="male" name="gender" value="male" required>
                        <label for="male">Male</label>
                        <input type="radio" id="female" name="gender" value="female">
                        <label for="female">Female</label>
                        <input type="radio" id="prefer-not" name="gender" value="prefer_not_say">
                        <label for="prefer-not">Prefer not to say</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="reg-username">Username:</label>
                    <input type="text" id="reg-username" name="username" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <label for="reg-password">Password:</label>
                    <input type="password" id="reg-password" name="password" placeholder="Password" required>
                </div>
                <div class="form-group">
                    <label for="reg-confirm-password">Confirm Password:</label>
                    <input type="password" id="reg-confirm-password" name="confirm_password" placeholder="Password"
                        required>
                </div>
                <button type="submit">Register Now!</button>
                <p class="login-link">
                    Have already an account? <a href="#" id="switchToLogin">Login Here</a>
                </p>
                 </form>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        // *** UPDATED FIRESTORE IMPORT ***
        import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js"; // Optional

        // Your web app's Firebase configuration
        const firebaseConfig = {
            // --- MAKE SURE THIS API KEY IS YOUR COMPLETE AND CORRECT KEY ---
            apiKey: "AIzaSyAp19_1RwloTbJLZ_K723-m8C2zka8Oh10",
            // --- ----------------------------------------------------- ---
            authDomain: "gjsbooking-faba9.firebaseapp.com",
            projectId: "gjsbooking-faba9",
            storageBucket: "gjsbooking-faba9.firebasestorage.app",
            messagingSenderId: "708149149410",
            appId: "1:708149149410:web:dde6a5b99b4900dd8c28bb",
            measurementId: "G-5QB9413PJH" // Optional
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app); // Optional

        // --- Wait for the DOM to be fully loaded ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- Firebase Registration (No changes needed here for login update) ---
            const registrationForm = document.getElementById('registrationForm');
            const emailInput = document.getElementById('reg-email');
            const passwordInput = document.getElementById('reg-password');
            const confirmPasswordInput = document.getElementById('reg-confirm-password');
            const usernameInput = document.getElementById('reg-username');
            const firstnameInput = document.getElementById('reg-firstname');
            const lastnameInput = document.getElementById('reg-lastname');
            const contactInput = document.getElementById('reg-contact');
            const genderInputs = document.getElementsByName('gender');
            const registerButton = registrationForm ? registrationForm.querySelector('button[type="submit"]') : null;
            const registerMessage = document.createElement('p');

            if (registrationForm && registerButton) {
                registerMessage.classList.add('registration-message');
                registerMessage.style.cssText = "text-align: center; margin-top: 10px; font-weight: bold; color: blue;";
                registrationForm.appendChild(registerMessage);

                registrationForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    registerButton.disabled = true;
                    registerMessage.textContent = "Registering...";
                    registerMessage.style.color = "blue";
                    const selectedGender = [...genderInputs].find(input => input.checked)?.value || "";
                    const password = passwordInput ? passwordInput.value : '';
                    const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';

                    if (password.length < 8) { // Optional: 8 char check
                        registerMessage.textContent = "Password must be at least 8 characters long.";
                        registerMessage.style.color = "red";
                        registerButton.disabled = false;
                        return;
                    }
                    if (password !== confirmPassword) {
                        registerMessage.textContent = "Passwords do not match.";
                        registerMessage.style.color = "red";
                        registerButton.disabled = false;
                        return;
                    }
                    if (!emailInput?.value || !password || !usernameInput?.value || !firstnameInput?.value || !lastnameInput?.value || !contactInput?.value || !selectedGender) {
                        registerMessage.textContent = "Please fill in all required fields.";
                        registerMessage.style.color = "red";
                        registerButton.disabled = false;
                        return;
                     }
                    registerUser(emailInput.value, password, usernameInput.value, firstnameInput.value, lastnameInput.value, contactInput.value, selectedGender);
                });
            } else { console.error("Registration form or button not found!"); }

            async function registerUser(email, password, username, firstname, lastname, contact, gender) {
                // --- Consider adding username uniqueness check here in future ---
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    console.log("Auth success. UID:", user.uid);
                    const userDocRef = doc(db, "users", user.uid);
                    // Save username in lowercase for case-insensitive lookup during login? Optional.
                    // const usernameLower = username.toLowerCase();
                    // await setDoc(userDocRef, { email, username: usernameLower, ... });
                    await setDoc(userDocRef, { email, username, firstname, lastname, contact, gender, createdAt: new Date(), isAdmin: false });
                    console.log("Firestore save success.");
                    registerMessage.textContent = "Registration successful!";
                    registerMessage.style.color = "green";
                } catch (error) {
                    console.error("Registration error:", error);
                    let errorMessage = "Registration failed.";
                    if (error.code === 'auth/email-already-in-use') errorMessage = "Email already in use.";
                    else if (error.code === 'auth/invalid-email') errorMessage = "Invalid email.";
                    else if (error.code === 'auth/weak-password') errorMessage = "Password needs 6+ characters.";
                    registerMessage.textContent = errorMessage;
                    registerMessage.style.color = "red";
                } finally { if (registerButton) registerButton.disabled = false; }
            }

            // --- Firebase Login (UPDATED for Username/Password) ---
            const loginForm = document.getElementById('loginForm');
            const loginUsernameInput = document.getElementById('login-email-user'); // Keep ID, it accepts username now
            const loginPasswordInput = document.getElementById('login-password');
            const loginButton = loginForm ? loginForm.querySelector('button[type="submit"]') : null;
            const loginMessage = document.createElement('p');

            if (loginForm && loginButton) {
                loginMessage.classList.add('login-message');
                loginMessage.style.cssText = "text-align: center; margin-top: 10px; font-weight: bold; color: blue;";
                loginForm.appendChild(loginMessage);

                loginForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    loginButton.disabled = true;
                    loginMessage.textContent = "Logging in..."; // Changed initial message
                    loginMessage.style.color = "blue";
                    // Pass the username input value to the updated loginUser function
                    loginUser(loginUsernameInput.value, loginPasswordInput.value);
                });
            } else { console.error("Login form or button not found!"); }


            // *** REPLACED loginUser function ***
            async function loginUser(usernameInput, password) {
                if (!usernameInput || !password) {
                    loginMessage.textContent = "Please enter username and password.";
                    loginMessage.style.color = "red";
                    if (loginButton) loginButton.disabled = false;
                    return;
                }

                let userEmail = null; // Variable to store the email found

                try {
                    // --- Step 1: Look up username in Firestore ---
                    loginMessage.textContent = "Verifying username...";
                    loginMessage.style.color = "blue";

                    const usersRef = collection(db, "users");
                    // Consider querying lowercase version if you save usernames as lowercase
                    // const usernameLower = usernameInput.toLowerCase();
                    // const q = query(usersRef, where("username", "==", usernameLower), limit(1));
                    const q = query(usersRef, where("username", "==", usernameInput), limit(1)); // Case-sensitive query

                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        console.log("No user found with username:", usernameInput);
                        loginMessage.textContent = "Invalid username or password."; // Generic error
                        loginMessage.style.color = "red";
                        if (loginButton) loginButton.disabled = false;
                        return;
                    }

                    // Username found, get the associated email
                    querySnapshot.forEach((doc) => {
                        userEmail = doc.data().email;
                        console.log(`Found email ${userEmail} for username ${usernameInput}`);
                    });

                    if (!userEmail) {
                         console.error("Username found but email was missing in Firestore document.");
                         loginMessage.textContent = "Login failed (error code: LUE). Please contact support.";
                         loginMessage.style.color = "red";
                         if (loginButton) loginButton.disabled = false;
                         return;
                    }

                    // --- Step 2: Attempt Firebase Auth sign-in using the FOUND email ---
                    loginMessage.textContent = "Logging in..."; // Update status

                    const userCredential = await signInWithEmailAndPassword(auth, userEmail, password); // Use the FOUND email
                    const user = userCredential.user;
                    console.log("Login success. UID:", user.uid);

                    // *** Admin Check (Same as before) ***
                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);
                    let isAdmin = false;
                    if (docSnap.exists()) { isAdmin = docSnap.data().isAdmin === true; }
                    else { console.warn("User doc not found:", user.uid); }

                    loginMessage.textContent = "Login successful! Redirecting...";
                    loginMessage.style.color = "green";
                    setTimeout(() => { window.location.href = isAdmin ? "admin-dashboard.html" : "dashboard.html"; }, 1500);

                } catch (error) {
                    // This catch block handles errors from BOTH Firestore query AND Auth sign-in
                    console.error("Login process error:", error);
                    // Make the error generic because we don't know if it was username lookup or password
                    loginMessage.textContent = "Invalid username or password.";
                    loginMessage.style.color = "red";
                    if (loginButton) loginButton.disabled = false;
                }
            } // End of updated loginUser function


            // --- Modal Logic (No changes needed here for login update) ---
            const loginLink = document.getElementById('loginLink');
            const registerLink = document.getElementById('registerLink');
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const loginCloseButton = loginModal ? loginModal.querySelector('.login-close-button') : null;
            const registerCloseButton = registerModal ? registerModal.querySelector('.register-close-button') : null;
            const switchToRegister = document.getElementById('switchToRegister');
            const switchToLogin = document.getElementById('switchToLogin');

            function closeAllModals() {
                if (registerModal) registerModal.style.display = "none";
                if (loginModal) loginModal.style.display = "none";
                if (loginMessage) loginMessage.textContent = '';
                if (registerMessage) registerMessage.textContent = '';
            }

            if (loginLink && registerLink && loginModal && registerModal && loginCloseButton && registerCloseButton && switchToRegister && switchToLogin) {
                loginLink.addEventListener('click', (e) => { e.preventDefault(); closeAllModals(); loginModal.style.display = 'block'; });
                registerLink.addEventListener('click', (e) => { e.preventDefault(); closeAllModals(); registerModal.style.display = 'block'; });
                loginCloseButton.addEventListener('click', closeAllModals);
                registerCloseButton.addEventListener('click', closeAllModals);
                window.addEventListener('click', (event) => { if (event.target === loginModal || event.target === registerModal) { closeAllModals(); } });
                switchToRegister.addEventListener('click', (e) => { e.preventDefault(); closeAllModals(); registerModal.style.display = 'block'; });
                switchToLogin.addEventListener('click', (e) => { e.preventDefault(); closeAllModals(); loginModal.style.display = 'block'; });
            } else { console.error("Modal Error: One or more elements not found."); }

        }); // End of DOMContentLoaded listener

    </script>

</body>
</html>
